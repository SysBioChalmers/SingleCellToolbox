%This function imports several single cell datasets into matlab and also
%saves them into .mat files. The purpose of that is that the .mat files
%takes much shorter time to load, so if a .mat file exists that one will be
%loaded instead of the original dataset file.
%To reimport them, just remove the .mat files and run this script again.

%get some paths
codeDir = fileparts(which(mfilename));

%set current directory to the directory of this file (restored at the end of the file)
prevDir = pwd();
cd(codeDir);

%read FANTOM5
fantom5Fn = '../../TempData/fantom5.mat';
disp('SetupCTProfiles: Reading fantom5');
if ~exist(fantom5Fn,'file')
    disp('SetupCTProfiles: No .mat file found, importing data');
    fantom5 = ReadFANTOM5('../../ImportableData/FANTOM5/data.txt');
    save(fantom5Fn, 'fantom5');
else
    load(fantom5Fn);
end
    


%% B Cells
%
bcellFn = '../../TempData/bcells.mat';

needImport = ~exist(bcellFn,'file');


if (needImport)
    disp('SetupCTProfiles: bcells.mat not found, importing data');
    bcells = Samples;
    
    %read ENCODE bCells
    disp('SetupCTProfiles: Reading encode bcell samples');
    files = {'../../ImportableData/ENCODE/B-cells/ENCFF231GYC.tsv'; ...
             '../../ImportableData/ENCODE/B-cells/ENCFF485EUP.tsv'; ...
             '../../ImportableData/ENCODE/B-cells/ENCFF770XDU.tsv'};
    ids = {'B-cell ENCFF231GYC'; ...
           'B-cell ENCFF485EUP'; ...
           'B-cell ENCFF770XDU'};
       
    encb = ReadEncodeSamples(files, ids, SCDep.geneInfo);
    
    %read Blueprint b cells
    disp('SetupCTProfiles: Reading blueprint bcell samples');
    files = { '../../ImportableData/Blueprint/BCells/EGAD00001002315/S019EW11.gene_quantification.rsem_grape2_crg.GRCh38.20160531.results'; ...
              '../../ImportableData/Blueprint/BCells/EGAD00001002315/S019KK11.gene_quantification.rsem_grape2_crg.GRCh38.20160531.results'; ...
              '../../ImportableData/Blueprint/BCells/EGAD00001002315/S01NDF11.gene_quantification.rsem_grape2_crg.GRCh38.20160531.results'; ...
              '../../ImportableData/Blueprint/BCells/EGAD00001002315/S019JM11.gene_quantification.rsem_grape2_crg.GRCh38.20160531.results'; ...
              '../../ImportableData/Blueprint/BCells/EGAD00001002315/S01GJV11.gene_quantification.rsem_grape2_crg.GRCh38.20160531.results'; ...
              '../../ImportableData/Blueprint/BCells/EGAD00001002315/S019HQ11.gene_quantification.rsem_grape2_crg.GRCh38.20160531.results'; ...
              '../../ImportableData/Blueprint/BCells/EGAD00001001145/C001NBB1.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/BCells/EGAD00001001145/C005MY12.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/BCells/EGAD00001002347/C001NBB3.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/BCells/EGAD00001002414/S019NE11.gene_quantification.rsem_grape2_crg.GRCh38.20160531.results'; ...
              '../../ImportableData/Blueprint/BCells/EGAD00001002452/S00Y9O11.gene_quantification.rsem_grape2_crg.GRCh38.20160531.results'; ...
              '../../ImportableData/Blueprint/BCells/EGAD00001002452/S013AR11.gene_quantification.rsem_grape2_crg.GRCh38.20160531.results'; ...
              '../../ImportableData/Blueprint/BCells/EGAD00001002452/S019FU11.gene_quantification.rsem_grape2_crg.GRCh38.20160531.results'; ...
              '../../ImportableData/Blueprint/BCells/EGAD00001002476/C001NBB4.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/BCells/EGAD00001002476/S01TDS11.gene_quantification.rsem_grape2_crg.GRCh38.20160531.results'; ...
              '../../ImportableData/Blueprint/BCells/EGAD00001002476/S019MG11.gene_quantification.rsem_grape2_crg.GRCh38.20160531.results' ...
              };
    ids = {'B-cell Naive B cell Tonsil BP S019EW11'; ...
           'B-cell Naive B cell Venous blood BP S019KK11'; ...
           'B-cell Naive B cell Tonsil BP S01NDF11'; ...
           'B-cell Naive B cell Venous blood BP S019JM11'; ...
           'B-cell Naive B cell Tonsil BP S01GJV11'; ...
           'B-cell Naive B cell Venous blood BP S019HQ11'; ...
           'B-cell Naive B cell CD38-negative venous blood BP C001NBB1'; ...
           'B-cell Naive B cell CD38-negative cord blood BP C005MY12'; ...
           'B-cell Memory B cell CD38-negative BP C001NBB3'; ...
           'B-cell Unswitched memory B cell BP S019NE11'; ...
           'B-cell Germinal center B cell BP S00Y9O11'; ...
           'B-cell Germinal center B cell BP S013AR11'; ...
           'B-cell Germinal center B cell BP S019FU11'; ...
           'B-cell Class switched memory B cell BP C001NBB4'; ...
           'B-cell Class switched memory B cell BP S01TDS11'; ...
           'B-cell Class switched memory B cell BP S019MG11' ...
           };
       
    bpb = ReadEncodeSamples(files, ids, SCDep.geneInfo);%same format as ENCODE
    %read GSE51984 b cells
    disp('SetupCTProfiles: Reading GSE51984 bcell samples');
    files = {'../../ImportableData/GSE51984/GSM1256812_B_01_RPKM.txt'; ...
             '../../ImportableData/GSE51984/GSM1256813_B_02_RPKM.txt'; ...
             '../../ImportableData/GSE51984/GSM1256814_B_03_RPKM.txt'; ...
             '../../ImportableData/GSE51984/GSM1256815_B_04_RPKM.txt'; ...
             '../../ImportableData/GSE51984/GSM1256816_B_05_RPKM.txt'};
    ids = {'B01 GSE51984'; ...
           'B02 GSE51984'; ...
           'B03 GSE51984'; ...
           'B04 GSE51984'; ...
           'B05 GSE51984'};
       
    gse51984b = ReadRPKMType1Samples(files, ids, SCDep.geneInfo);
    
    %Find the b cells in fantom5. Those are identified from that they have
    %the text "B cells" in their sample id
    
    matches = regexp(fantom5.sampleIds, '.*B%20Cells.*', 'match');
    bc = ~cellfun(@isempty, matches);
    fantom5b = fantom5.cellSubset(bc);
    
    %now join all bcell samples into a single dataset
    bcells = fantom5b.innerJoin(encb);
    bcells = bcells.innerJoin(bpb);
    bcells = bcells.innerJoin(gse51984b);
    
    save(bcellFn, 'bcells');
else
    load(bcellFn);
end

%% T Cells CD8
%
tcellCD8Fn = '../../TempData/tcellsCD8.mat';

needImport = ~exist(tcellCD8Fn,'file');


if (needImport)
    disp('SetupCTProfiles: tcellsCD8.mat not found, importing data');
    tcellsCD8 = Samples;
    
    %read ENCODE tCells
    disp('SetupCTProfiles: Reading encode tcell samples');
    files = { '../../ImportableData/ENCODE/T-cells/ENCFF088DIY.tsv'; ...
        ... %Skip this one, don't know if CD4 or CD8 '../../ImportableData/ENCODE/T-cells/ENCFF158VJT.tsv'; ...
        '../../ImportableData/ENCODE/T-cells/ENCFF372OMD.tsv'; ...
        };
    
    ids = { ... %'T-cell 1 ENCFF088DIY'; ...
        'T-cell CD8+ alpha beta ENCFF088DIY'; ...
        'T-cell CD8+ alpha beta ENCFF372OMD'; ...
        };

    enct = ReadEncodeSamples(files, ids, SCDep.geneInfo);
    
    %read Blueprint t cells
    disp('SetupCTProfiles: Reading blueprint CD8+ tcell samples');
    files = { '../../ImportableData/Blueprint/TCells/EGAD00001001137/C0066P12.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001001137/S00C2F11.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001001483/EC-TH91.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001002320/S01H8C11.gene_quantification.rsem_grape2_crg.GRCh38.20160531.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001002456/C001HNB3.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001002456/S014TM11.gene_quantification.rsem_grape2_crg.GRCh38.20160531.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001002482/C001HNB2.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAX00001244774/SP8-TH91.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
             };
    ids = {'T-cell Cord blood CD8-positive, alpha-beta T cell C0066P12'; ...
           'T-cell Cord blood CD8-positive, alpha-beta T cell S00C2F11'; ...
           'T-cell CD3-negative, CD4-positive, CD8-positive, double positive EC-TH91'; ... %double positive, i see this as CD8+
           'T-cell effector memory CD8-positive, alpha-beta T cell, terminally differentiated S01H8C11'; ...
           'T-cell effector memory CD8-positive, alpha-beta C001HNB3'; ...
           'T-cell effector memory CD8-positive, alpha-beta S014TM11'; ...
           'T-cell central memory CD8-positive, alpha-beta C001HNB2'; ...
           'T-cell CD8-positive, alpha-beta SP8-TH91'; ...           
           };
       
    bpt = ReadEncodeSamples(files, ids, SCDep.geneInfo);%same format as ENCODE
    %read GSE51984 b cells - skip these since we cannot distinguish between
    %CD4 and CD8
%    disp('SetupCTProfiles: Reading GSE51984 bcell samples');
%    files = {'../../ImportableData/GSE51984/GSM1256828_T_01_RPKM.txt'; ...
%             '../../ImportableData/GSE51984/GSM1256829_T_02_RPKM.txt'; ...
%             '../../ImportableData/GSE51984/GSM1256830_T_03_RPKM.txt'; ...
%             '../../ImportableData/GSE51984/GSM1256831_T_04_RPKM.txt'; ...
%             '../../ImportableData/GSE51984/GSM1256832_T_05_RPKM.txt'};
%    ids = {'T01 GSE51984'; ...
%           'T02 GSE51984'; ...
%           'T03 GSE51984'; ...
%           'T04 GSE51984'; ...
%           'T05 GSE51984'};
       
%    gse51984t = ReadRPKMType1Samples(files, ids, SCDep.geneInfo);
    
    %Find the t cells in fantom5. Those are identified from that they have
    %the text "T cells" in their sample id
    
    matches = regexp(fantom5.sampleIds, '.*CD8%.*T%20Cells.*', 'match');
    tc = ~cellfun(@isempty, matches);
    fantom5t = fantom5.cellSubset(tc);
    
    %now join all tcell samples into a single dataset
    tcellsCD8 = fantom5t.innerJoin(enct);
    tcellsCD8 = tcellsCD8.innerJoin(bpt);
    %tcellsCD8 = tcellsCD8.innerJoin(gse51984t);
    
    save(tcellCD8Fn, 'tcellsCD8');
else
    load(tcellCD8Fn);
end

%% T Cells CD4
%
tcellCD4Fn = '../../TempData/tcellsCD4.mat';

needImport = ~exist(tcellCD4Fn,'file');


if (needImport)
    disp('SetupCTProfiles: tcellsCD4.mat not found, importing data');
    tcellsCD4 = Samples;
    
    %read ENCODE tCells
    disp('SetupCTProfiles: Reading encode tcell samples');
    files = { ...
        '../../ImportableData/ENCODE/T-cells/ENCFF760LWW.tsv'; ...
        '../../ImportableData/ENCODE/T-cells/ENCFF794NBU.tsv'};
    
    ids = {'T-cell CD4+ ENCFF760LWW'; ...
        'T-cell CD4+ ENCFF794NBU'};

    enct = ReadEncodeSamples(files, ids, SCDep.geneInfo);
    
    %read Blueprint t cells
    disp('SetupCTProfiles: Reading blueprint CD4+ tcell samples');
    files = { '../../ImportableData/Blueprint/TCells/EGAD00001001173/C001FRB1.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001001173/S000RD15.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001001173/S002EV11.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001001173/S004M711.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001001173/S007DD11.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001001173/S007G711.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001001173/S008H111.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001001173/S009W411.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001001173/S0018A13.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001001173/S0041C11.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001002349/C001FRB3.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001002349/S014QS11.gene_quantification.rsem_grape2_crg.GRCh38.20151028.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001002351/C001FRB2.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001002469/C001FRB4.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/TCells/EGAD00001002469/S014QS12.gene_quantification.rsem_grape2_crg.GRCh38.20151028.results'; ...
             };
    ids = {'T-cell CD4-positive, alpha-beta C001FRB1'; ...
           'T-cell CD4-positive, alpha-beta S000RD15'; ...
           'T-cell CD4-positive, alpha-beta S002EV11'; ...
           'T-cell CD4-positive, alpha-beta S004M711'; ...
           'T-cell CD4-positive, alpha-beta S007DD11'; ...
           'T-cell CD4-positive, alpha-beta S00CG711'; ...
           'T-cell CD4-positive, alpha-beta S008H111'; ...
           'T-cell CD4-positive, alpha-beta S009W411'; ...
           'T-cell CD4-positive, alpha-beta S0018A13'; ...
           'T-cell CD4-positive, alpha-beta S0041C11'; ...
           'T-cell central memory CD4-positive, alpha-beta C001FRB3'; ...
           'T-cell central memory CD4-positive, alpha-beta S014QS11'; ...
           'T-cell regulatory C001FRB2'; ...
           'T-cell effector memory CD4-positive, alpha-beta C001FRB4'; ...
           'T-cell effector memory CD4-positive, alpha-beta S014QS12'; ...
           };
       
    bpt = ReadEncodeSamples(files, ids, SCDep.geneInfo);%same format as ENCODE
    %read GSE51984 t cells
    %skip these, not divided into CD4+/CD8+
%    disp('SetupCTProfiles: Reading GSE51984 bcell samples');
%    files = {'../../ImportableData/GSE51984/GSM1256828_T_01_RPKM.txt'; ...
%             '../../ImportableData/GSE51984/GSM1256829_T_02_RPKM.txt'; ...
%             '../../ImportableData/GSE51984/GSM1256830_T_03_RPKM.txt'; ...
%             '../../ImportableData/GSE51984/GSM1256831_T_04_RPKM.txt'; ...
%             '../../ImportableData/GSE51984/GSM1256832_T_05_RPKM.txt'};
%    ids = {'T01 GSE51984'; ...
%           'T02 GSE51984'; ...
%           'T03 GSE51984'; ...
%           'T04 GSE51984'; ...
%           'T05 GSE51984'};
       
%    gse51984t = ReadRPKMType1Samples(files, ids, SCDep.geneInfo);
    
    %Find the t cells in fantom5. Those are identified from that they have
    %the text "T cells" in their sample id
    
    matches = regexp(fantom5.sampleIds, '.*CD4%.*T%20[cC]ells.*', 'match');
    tc = ~cellfun(@isempty, matches);
    fantom5t = fantom5.cellSubset(tc);
    
    %now join all tcell samples into a single dataset
    tcellsCD4 = fantom5t.innerJoin(enct);
    tcellsCD4 = tcellsCD4.innerJoin(bpt);
    %tcellsCD4 = tcellsCD4.innerJoin(gse51984t);
    
    save(tcellCD4Fn, 'tcellsCD4');
else
    load(tcellCD4Fn);
end

%% T Cells (not specified if CD4 or CD8)
%
tcellFn = '../../TempData/tcells.mat';

needImport = ~exist(tcellFn,'file');


if (needImport)
    disp('SetupCTProfiles: .mat not found, importing data');
    tcells = Samples;
    
    %read ENCODE tCells
    disp('SetupCTProfiles: Reading encode tcell samples');
    files = { '../../ImportableData/ENCODE/T-cells/ENCFF158VJT.tsv'; ...
        };
    
    ids = {'T-cell ENCFF158VJT' ...
        };

    enct = ReadEncodeSamples(files, ids, SCDep.geneInfo);
    
    %All Blueprint t cell samples are either CD4+ or CD8+
    
    %read GSE51984 t cells 
    disp('SetupCTProfiles: Reading GSE51984 T cell samples');
    files = {'../../ImportableData/GSE51984/GSM1256828_T_01_RPKM.txt'; ...
             '../../ImportableData/GSE51984/GSM1256829_T_02_RPKM.txt'; ...
             '../../ImportableData/GSE51984/GSM1256830_T_03_RPKM.txt'; ...
             '../../ImportableData/GSE51984/GSM1256831_T_04_RPKM.txt'; ...
             '../../ImportableData/GSE51984/GSM1256832_T_05_RPKM.txt'};
    ids = {'T01 GSE51984'; ...
           'T02 GSE51984'; ...
           'T03 GSE51984'; ...
           'T04 GSE51984'; ...
           'T05 GSE51984'};
       
    gse51984t = ReadRPKMType1Samples(files, ids, SCDep.geneInfo);
    
    %all fantom 5 T cell samples are either CD4+ or CD8+
    
    %now join all tcell samples into a single dataset
    tcells = gse51984t.innerJoin(enct);
    
    save(tcellFn, 'tcells');
else
    load(tcellFn);
end



%% NK Cells
%
nkcellFn = '../../TempData/nkcells.mat';

needImport = ~exist(nkcellFn,'file');


if (needImport)
    disp('SetupCTProfiles: nkcells.mat not found, importing data');
    nkcells = Samples;
    
    %read ENCODE tCells
    disp('SetupCTProfiles: Reading encode nk cell samples');
    files = { ...
        '../../ImportableData/ENCODE/NK-cells/ENCFF036GDL.tsv'};
    
    ids = {'NK-cell CD56dim ENCFF036GDL'};

    encnk = ReadEncodeSamples(files, ids, SCDep.geneInfo);
    
    %read Blueprint cells
    disp('SetupCTProfiles: Reading blueprint nk cell samples');
    files = { '../../ImportableData/Blueprint/NKCells/EGAD00001002321/C001MDB1.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/NKCells/EGAD00001002321/C001R3B2.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/NKCells/EGAD00001002321/C0067N12.gene_quantification.rsem_grape2_crg.GRCh38.20150622.results'; ...
              '../../ImportableData/Blueprint/NKCells/EGAD00001002321/S01E8O11.gene_quantification.rsem_grape2_crg.GRCh38.20160531.results'; ...
              };
    ids = {'NK-cell cytotoxic CD56-dim C001MDB1'; ...
           'NK-cell cytotoxic CD56-dim C001R3B2'; ...
           'NK-cell cytotoxic CD56-dim C0067N12'; ...
           'NK-cell cytotoxic CD56-dim S01E8O11'; ...
           };
       
    bpnk = ReadEncodeSamples(files, ids, SCDep.geneInfo);%same format as ENCODE
    %read GSE51984 t cells
    %there are none....
    
    %Find the cells in fantom5. 
    
    matches = regexp(fantom5.sampleIds, '.*Natural%20Killer%20Cells.*', 'match');
    tc = ~cellfun(@isempty, matches);
    fantom5nk = fantom5.cellSubset(tc);
    
    %now join all tcell samples into a single dataset
    nkcells = fantom5nk.innerJoin(encnk);
    nkcells = nkcells.innerJoin(bpnk);
    
    save(nkcellFn, 'nkcells');
else
    load(nkcellFn);
end



%restore current directory
cd(prevDir);

